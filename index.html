<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××©×—×§ ××¡×¤×¨×™× â€” ×¨××”/×©××¢ ×•×œ×—×¥</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#38bdf8; --btn:#1f2937; --btnh:#374151; --ok:#22c55e; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      background:linear-gradient(145deg,#0b1220,var(--bg));color:var(--text);
      min-height:100dvh;display:grid;place-items:center;padding:14px;-webkit-user-select:none;user-select:none;
    }
    .wrap{width:100%;max-width:760px;background:linear-gradient(180deg,#0c111b,var(--card));
      border:1px solid #1f2937;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 12px 0 12px;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn,.sel{background:var(--btn);color:var(--text);border:1px solid #2b3544;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--btnh)} .btn:active{transform:translateY(1px)}
    main{display:grid;gap:14px;padding:12px}
    .bar{display:grid;grid-template-columns:1fr auto auto auto auto;gap:8px;align-items:center;color:var(--muted);font-size:14px}
    .pill{background:#0b1220;border:1px solid #243042;padding:8px 10px;border-radius:999px;font-weight:800;color:var(--text)}
    .big{display:grid;place-items:center;min-height:120px;background:#0b1220;border:1px dashed #2b3544;border-radius:12px}
    .big span{font-size:clamp(56px,12vw,112px);font-weight:900;color:var(--accent);text-shadow:0 6px 40px rgba(56,189,248,.25)}
    .hint{text-align:center;font-size:14px;color:var(--muted);margin-top:-6px}
    .pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding-bottom:12px}
    .key{
      background:linear-gradient(180deg,#0f172a,#111827);border:1px solid #263142;border-radius:12px;
      padding:18px 12px;font-size:clamp(22px,5vw,28px);font-weight:900;text-align:center;cursor:pointer;transition:.15s;
      color:var(--text);text-shadow:0 1px 0 rgba(0,0,0,.35);
    }
    .key:active{transform:translateY(1px)}
    .key:focus-visible{outline:3px solid rgba(56,189,248,.6);outline-offset:2px}
    .ok{border-color:rgba(34,197,94,.7);box-shadow:0 0 0 3px rgba(34,197,94,.15) inset;background:rgba(34,197,94,.08)}
    .bad{border-color:rgba(239,68,68,.7);box-shadow:0 0 0 3px rgba(239,68,68,.15) inset;background:rgba(239,68,68,.08)}

    /* ×©×œ×‘ 3 â€“ ×¡×¦× ×” ×¢× ×ª××•× ×•×ª (××™××•×’'×™×) */
    .scene{
      display:none; /* ××•×¦×’ ×¨×§ ×‘×©×œ×‘ 3 */
      background:#0b1220;border:1px solid #243042;border-radius:12px;padding:12px;
    }
    .scene.on{display:block}
    .scene-grid{
      display:grid;gap:10px;
      grid-template-columns:repeat(5,minmax(40px,1fr));
      justify-items:center;align-items:center;
    }
    .stamp{
      font-size:clamp(36px,7vw,56px); filter: drop-shadow(0 2px 2px rgba(0,0,0,.25));
      line-height:1.1;
    }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="××©×—×§ ××¡×¤×¨×™× â€” ×¢×‘×¨×™×ª">
    <header>
      <h1>××©×—×§ ××¡×¤×¨×™× â€” ×¨××”/×©××¢ ×•×œ×—×¥</h1>
      <div class="row">
        <button id="start" class="btn">×”×ª×—×œ</button>
        <button id="next"  class="btn">×©×œ×‘ ×”×‘×</button>
        <button id="replay" class="btn" title="×”×©××¢ ×©×•×‘">×”×©××¢ ×©×•×‘ ğŸ”</button>
        <select id="lvl" class="sel" aria-label="×¨××”">
          <option value="1">×©×œ×‘ 1: ×œ×¨××•×ª + ×œ×©××•×¢</option>
          <option value="2">×©×œ×‘ 2: ×œ×©××•×¢ ×‘×œ×‘×“</option>
          <option value="3">×©×œ×‘ 3: ×¡×•×¤×¨×™× ×ª××•× ×•×ª</option>
        </select>
        <select id="lang" class="sel" aria-label="×©×¤×”">
          <option value="he-IL" selected>×¢×‘×¨×™×ª</option>
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
        </select>
      </div>
      <div class="row">
        <button id="testBeep" class="btn">ğŸ”Š Test Beep</button>
        <button id="testVoice" class="btn">ğŸ—£ï¸ Test Voice</button>
        <select id="voiceSelect" class="sel" title="×‘×—×¨ ×§×•×œ ×–××™×Ÿ (×× ×™×©)">
          <option value="">(Auto) ×‘×—×¨ ×§×•×œ...</option>
        </select>
        <button id="tts" class="btn" aria-pressed="true">ğŸ”Š ×§×•×œ: ×¤×¢×™×œ</button>
      </div>
    </header>

    <main>
      <div class="bar">
        <div class="pill">×©×œ×‘: <span id="sLvl">1</span></div>
        <div class="pill">× ×™×§×•×“: <span id="sOk">0</span>/<span id="sAll">0</span></div>
        <div class="pill">×¨×¦×£: <span id="sSt">0</span></div>
        <div class="pill" id="voiceStatus" title="×¡×˜×˜×•×¡ ×“×™×‘×•×¨">×§×•×œ: â€¦</div>
        <div class="pill" id="audioStatus" title="×¡×˜×˜×•×¡ ××•×“×™×•">××•×“×™×•: â€¦</div>
      </div>

      <div class="big" aria-live="polite"><span id="big">â€”</span></div>
      <div id="scene" class="scene" aria-label="×¡×¦× ×ª ×¡×¤×™×¨×”">
        <div id="sceneGrid" class="scene-grid" aria-live="polite"></div>
      </div>

      <div class="hint" id="hint">×œ×—×¥ <b>×”×ª×—×œ</b> ×›×“×™ ×œ×”×ª×—×™×œ.</div>
      <div class="pad" id="pad"></div>
    </main>
  </div>

  <script>
  (function(){
    const $ = (q)=>document.querySelector(q);
    const start=$("#start"), next=$("#next"), replay=$("#replay"), lvl=$("#lvl"), lang=$("#lang"), tts=$("#tts");
    const testBeep=$("#testBeep"), testVoice=$("#testVoice"), voiceSelect=$("#voiceSelect");
    const sLvl=$("#sLvl"), sOk=$("#sOk"), sAll=$("#sAll"), sSt=$("#sSt");
    const big=$("#big"), pad=$("#pad"), hint=$("#hint"), voiceStatus=$("#voiceStatus"), audioStatus=$("#audioStatus");
    const scene=$("#scene"), sceneGrid=$("#sceneGrid");

    let cur=null, allow=false, tot=0, ok=0, st=0, ttsOn=true;
    const HE_WORDS = ["××¤×¡","××—×ª","×©×ª×™×™×","×©×œ×•×©","××¨×‘×¢","×—××©","×©×©","×©×‘×¢","×©××•× ×”","×ª×©×¢"];

    /* ×—×¤×¦×™×/×—×™×•×ª ×œ×©×œ×‘ 3 â€” ××™××•×’'×™× ×©×œ× ×“×•×¨×©×™× ×§×‘×¦×™× ×—×™×¦×•× ×™×™× */
    const STAMPS = [
      {emoji:"ğŸ±", he:"×—×ª×•×œ×™×", en:"cats"},
      {emoji:"ğŸ¶", he:"×›×œ×‘×™×",  en:"dogs"},
      {emoji:"ğŸ°", he:"××¨× ×‘×™×", en:"rabbits"},
      {emoji:"ğŸ¦‹", he:"×¤×¨×¤×¨×™×", en:"butterflies"},
      {emoji:"ğŸ", he:"×—×™×¤×•×©×™×•×ª", en:"ladybugs"},
      {emoji:"ğŸŸ", he:"×“×’×™×",   en:"fish"},
      {emoji:"ğŸ", he:"×ª×¤×•×—×™×", en:"apples"},
      {emoji:"â­", he:"×›×•×›×‘×™×",  en:"stars"},
      {emoji:"ğŸŒ¸", he:"×¤×¨×—×™×",  en:"flowers"},
      {emoji:"ğŸš—", he:"××›×•× ×™×•×ª", en:"cars"}
    ];

    /* AUDIO (beep) + resume */
    let ctx=null; function getCtx(){ if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); return ctx; }
    async function ensureAudio(){
      try{ const c=getCtx(); if(c.state==='suspended'){ await c.resume(); }
        audioStatus.textContent='××•×“×™×•: âœ“'; audioStatus.title='AudioContext state: '+c.state;
      }catch(e){ audioStatus.textContent='××•×“×™×•: â€”'; audioStatus.title='Audio error: '+(e&&e.message); }
    }
    function beep(type){
      const c=getCtx(), o=c.createOscillator(), g=c.createGain();
      o.type='sine'; o.frequency.value = type==='ok'?880:180; g.gain.value=0.0001;
      o.connect(g).connect(c.destination); o.start();
      const t=c.currentTime; g.gain.exponentialRampToValueAtTime(0.2,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.25); o.stop(t+0.28);
    }

    /* SPEECH */
    let voicesCache=[];
    function refreshVoices(){ voicesCache=speechSynthesis.getVoices(); populateVoiceList(); updateVoiceStatus(); }
    function populateVoiceList(){
      const prev=voiceSelect.value; voiceSelect.innerHTML='<option value="">(Auto) ×‘×—×¨ ×§×•×œ...</option>';
      voicesCache.forEach((v,i)=>{ const opt=document.createElement('option'); opt.value=i.toString();
        opt.textContent=`${v.name} (${v.lang})`+(v.default?' â€” default':''); voiceSelect.appendChild(opt); });
      if(prev && +prev<voicesCache.length) voiceSelect.value=prev;
    }
    function pickVoice(langTag){
      const idx=voiceSelect.value; if(idx){ return voicesCache[+idx]||null; }
      if(!voicesCache.length) return null;
      let v=voicesCache.find(v=>v.lang===langTag)||voicesCache.find(v=>v.lang&&v.lang.toLowerCase().startsWith(langTag.split('-')[0].toLowerCase()));
      if(langTag.startsWith('he')) v=voicesCache.find(v=>/^he\b/i.test(v.lang))||v;
      return v||null;
    }
    function speakText(text, langTag){
      if(!ttsOn) return;
      const u=new SpeechSynthesisUtterance(text); u.lang=langTag;
      const v=pickVoice(langTag); if(v) u.voice=v;
      speechSynthesis.cancel(); speechSynthesis.speak(u); updateVoiceStatus(v);
    }
    function speakNumber(n){
      const langTag=lang.value||'he-IL';
      const txt = langTag.startsWith('he') ? HE_WORDS[n] : String(n);
      speakText(txt, langTag);
    }
    function updateVoiceStatus(v){
      const langTag=lang.value||'he-IL';
      const have=(voicesCache&&voicesCache.length)?(pickVoice(langTag)?"âœ“":"â€”"):"â€¦";
      voiceStatus.textContent=`×§×•×œ: ${have}`;
      voiceStatus.title=(v&&v.name)?`Voice: ${v.name} (${v.lang})`:(have==="â€”"?"×œ× × ××¦× ×§×•×œ ××ª××™× ××• ××™× ×• ××•×ª×§×Ÿ.":"×˜×•×¢×Ÿ ×§×•×œ×•×ª...");
    }
    if(typeof speechSynthesis!=='undefined'){ refreshVoices(); speechSynthesis.onvoiceschanged=refreshVoices; }

    /* GAME CORE */
    function rnd(max=10){ return Math.floor(Math.random()*max); }
    function between(min,max){ return Math.floor(Math.random()*(max-min+1))+min; } // inclusive
    function setLvl(){ sLvl.textContent=lvl.value; }

    function buildPad(){
      pad.innerHTML='';
      [1,2,3,4,5,6,7,8,9,'',0,''].forEach(n=>{
        const b=document.createElement('button'); b.className='key'; b.type='button';
        if(n===''){ b.disabled=true; b.style.visibility='hidden'; }
        else { b.textContent=String(n); b.setAttribute('aria-label','××¡×¤×¨ '+n);
          b.addEventListener('click', async ()=>{ await ensureAudio(); guess(n,b); });
        }
        pad.appendChild(b);
      });
    }

    function round(){
      // reset visuals
      document.querySelectorAll('.key').forEach(k=>k.classList.remove('ok','bad'));
      scene.classList.remove('on');
      sceneGrid.innerHTML='';
      cur=null; allow=false;

      const L=lvl.value;
      if(L==='1'){
        // see + hear (0â€“9)
        cur=rnd(10); // 0..9
        big.textContent=String(cur);
        hint.textContent='×œ×—×¥ ×¢×œ ×”×¡×¤×¨×” ×”××ª××™××”.';
        speakNumber(cur);
        allow=true;
      } else if(L==='2'){
        // hear only
        cur=rnd(10);
        big.textContent='â“';
        hint.textContent='×”×§×©×‘ ×•×œ×—×¥ ×¢×œ ×”×¡×¤×¨×” ×”× ×›×•× ×”.';
        speakNumber(cur);
        allow=true;
      } else {
        // L === '3' â€” Count items (1..9)
        cur=between(1,9);
        const stamp=STAMPS[between(0,STAMPS.length-1)];
        big.textContent='×¡×¤×¨/×™ ×•×¡××Ÿ/× ×™ ××ª ×”××¡×¤×¨';
        hint.textContent='×›××” ×™×© ×‘×ª××•× ×”?';
        scene.classList.add('on');

        // render N stamps in a grid
        for(let i=0;i<cur;i++){
          const d=document.createElement('div');
          d.className='stamp';
          d.textContent=stamp.emoji;
          d.setAttribute('aria-label', stamp.he);
          sceneGrid.appendChild(d);
        }

        // speak prompt (without revealing the number)
        const langTag=lang.value||'he-IL';
        if(langTag.startsWith('he')){
          speakText(`×›××” ${stamp.he} ×™×© ×‘×ª××•× ×”?`, 'he-IL');
        } else {
          speakText(`How many ${stamp.en} are there?`, langTag);
        }
        allow=true;
      }
    }

    function guess(n, el){
      if(!allow) return;
      tot++; sAll.textContent=tot;
      if(n===cur){ ok++; st++; el.classList.add('ok'); beep('ok'); }
      else { st=0; el.classList.add('bad'); beep('bad');
        const c=[...document.querySelectorAll('.key')].find(b=>b.textContent===String(cur));
        if(c){ c.classList.add('ok'); setTimeout(()=>c.classList.remove('ok'), 450); }
      }
      sOk.textContent=ok; sSt.textContent=st; allow=false; setTimeout(round, 700);
    }

    // build UI / wire
    buildPad();
    start.addEventListener('click', async ()=>{ tot=ok=st=0; sAll.textContent=sOk.textContent=sSt.textContent='0';
      setLvl(); hint.textContent='!×”××©×—×§ ×”×ª×—×™×œ'; await ensureAudio(); round(); });
    next.addEventListener('click', async ()=>{ lvl.value = (lvl.value==='1')?'2':(lvl.value==='2')?'3':'1';
      setLvl(); await ensureAudio(); round(); });
    replay.addEventListener('click', async ()=>{ await ensureAudio();
      if(lvl.value==='3'){ const langTag=lang.value||'he-IL';
        if(sceneGrid.childElementCount>0){
          const sample = langTag.startsWith('he') ? '×›××” ×™×© ×‘×ª××•× ×”?' : 'How many are there?';
          speakText(sample, langTag);
        }
      } else if(cur!==null){ speakNumber(cur); }
    });
    lvl.addEventListener('change', async ()=>{ setLvl(); await ensureAudio(); round(); });
    lang.addEventListener('change', ()=>{ updateVoiceStatus(); });
    tts.addEventListener('click', ()=>{ ttsOn=!ttsOn; tts.textContent = ttsOn?'ğŸ”Š ×§×•×œ: ×¤×¢×™×œ':'ğŸ”‡ ×§×•×œ: ×›×‘×•×™';
      tts.setAttribute('aria-pressed', String(ttsOn)); });

    testBeep.addEventListener('click', async ()=>{ await ensureAudio(); beep('ok'); });
    testVoice.addEventListener('click', ()=>{ const sample=(lang.value.startsWith('he'))?'×‘×“×™×§×ª ×§×•×œ ×‘×¢×‘×¨×™×ª':'This is a voice test';
      speakText(sample, lang.value); });

    // init statuses
    audioStatus.textContent='××•×“×™×•: â€¦';
  })();
  </script>
</body>
</html>
